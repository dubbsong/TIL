# Meteor 코딩 공작소

박승현 지음

<br>

### 들어가며

- 미티어(Meteor)는 자바스크립트 풀스택 플랫폼이다.
- 개발 속도가 빨라서 서비스를 신속하게 런칭하여 고객과 만날 수 있는 시간을 줄여준다.
- 브라우저뿐만 아니라 모바일에서도 빠르게 앱을 출시할 수 있다.
- 미티어는 기존에 작성한 코드를 많이 수정하지 않고 재사용할 수 있는 방법을 제공하고 있다.
- public 폴더에 기존 .html, .js를 넣고 미티어로 REST 서버를 만들어서 기존 프론트 코드가 잘 동작하게 하는 방법이다.
- 특히 리액티비티는 미티어의 주된 개념이다. 리액티비티는 가깝게 엑셀에서도 찾을 수 있는 오래된 개념이다.

<br>

### 1. 미티어 소개

- 미티어는 클라이언트(브라우저)부터 애플리케이션 서버(미티어 서버), 데이터베이스(몽고DB)에 이르기까지 자바스크립트로 구성된 풀스택 플랫폼이다.
- 미티어는 명령어 한 줄만으로 빠르게 개발 환경을 구성할 수 있으며, 브라우저부터 데이터베이스까지 실시간으로 데이터를 동기화하는 애플리케이션을 쉽게 작성할 수 있다.
- 미티어 패키지 저장소(atmosphere)에 있는 수많은 패키지를 나의 프로젝트에 설치하고 사용할 수 있다.

#### 1) 빠르게 구성하는 개발 환경

- 미티어는 명령줄에서 입력하는 한 줄의 프로젝트 생성 명령만으로 자체에 내장된 데이터베이스를 사용할 수 있다.
- 내장된 몽고DB는 JSON(JavaScript Object Notation)을 저장하는 데이터베이스로 요즘 주목받고 있는 NoSQL 데이터베이스 중 하나다.

#### 2) 브라우저와 서버 간 실시간 데이터 동기화

- 미티어는 발행/구독(publish/subscribe)이라는 구조로 브라우저와 서버 간의 데이터 교환이 이루어진다.
- 이 교환은 실시간으로 이루어지므로 데이터의 지속적인 변화를 실시간으로 보여주는 애플리케이션을 작성할 때 아주 좋다.
- 게다가 코드 몇 줄만으로 쉽게 동기화를 구현할 수 있다.

#### 3) 풀스택 자바스크립트

- 클라이언트와 서버에 이르기까지 모두 자바스크립트만으로 구현한다.
- 기본 데이터베이스로는 몽고DB를 사용한다.
- 몽고DB는 JSON을 저장하는 NoSQL 데이터베이스다.
- 클라이언트에서 작성된 데이터 포맷을 데이터베이스까지 같으 ㄴ형태로 저장할 수 있다.
- 그야말로 풀스택 자바스크립트 플랫폼이다.

#### 4) 모바일 통합 개발 환경

- 미티어에서 개발한 앱은 데스크탑뿐만 아니라 Android, iOS에서 사용할 수 있는 패키지로 배포할 수 있다.
- 특히 모바일 환경은 내장된 코르도바를 통하여 하이브리드 앱 형태로 배포하므로 별도의 컴파일 환경을 구축할 필요가 없이 미티어만으로 앱 제작이 가능하다.

#### 5) 풍부한 패키지

- [atmosphere](http://atmosphere.meteor.com/)는 미티어 패키지 저장소이며 Node.js의 npm과 비교될 수 있다.
- 미티어 콘솔에서 "meteor add 패키지명" 정도의 입력만으로 해당 패키지를 프로젝트에 적용할 수 있다.
- 만든 모듈을 atmosphere에 패키지로 등록할 수도 있다.

<br>

### 2. 개발 환경 설정

- 미티어는 Node.js 기반의 풀스택 플랫폼이지만 별도로 Node.js의 설치를 신경 쓸 필요가 없다.
- 몽고DB는 프로젝트를 생성하면 자동으로 내장되어 실행까지 된다.

#### 1) macOS, 리눅스 환경에서 설치하기

1. 미티어 설치 ($ curl https://install.meteor.com/ | sh)
2. 디렉토리 생성 ($ cd ~)
3. Project 폴더 생성 ($ mkdir Projects)
4. Project 디렉토리로 이동 ($ cd Projects)
5. 프로젝트 생성 ($ meteor create test)
6. test 프로젝트 폴더로 이동 ($ cd test)
7. 미티어 실행 ($ meteor)
8. 브라우저 확인 (http://localhost:3000/)

#### 4) helloworld 프로젝트 실습

1. helloworld 프로젝트 생성 ($ meteor create helloworld)
2. 디렉토리 이동 ($ cd helloworld)
3. 미티어 실행에 필요한 패키지 설치 ($ meteor npm install)
4. 디렉토리 이동 ($ cd client)
5. 미티어 프로젝트 실행 ($ meteor (run))
6. 브라우저 확인 (App running at: http://localhost:3000/)
7. main.html 수정 후 저장

- 실행 결과를 보면 meteor run 명령은 자체 프록시를 실행하고, 몽고DB를 실행한 뒤에 3000번 기본 포트에서 미티어 애플리케이션을 실행한다. 이때 몽고DB는 3001번 포트를 사용하게 된다. 또한, 내부 몽고DB는 로컬 호스트 밖의 외부에서 연결할 수 없다.
- 소스 코드를 수정하고 파일을 저장한 것만으로 브라우저에 수정 내용이 반영된다. 미티어는 소스 코드를 수정한 후에 재시작할 필요가 없다. 이를 핫 코드 푸시(hot code push, 코드 즉시 반영)라 부른다.

### 3. 주소록 만들기

- 미티어로 주소록을 구현하면 채팅처럼 접속자가 페이지를 새로 고치지 않아도 실시간으로 업데이트 되는 주소록도 쉽게 작성할 수 있다.
- 주소록 만들기 과정
  1. 주소록 프로젝트 생성
  2. 미티어 컬렉션 생성
  3. 주소록 초기 데이터 생성
  4. 주소록 목록 구현
  5. 주소록 삭제 템플릿 작성
  6. 주소록 등록 템플릿 작성
  7. 주소록 수정 구현
  8. 입력 데이터 검증
  9. 보안 적용
  10. 페이징 구현

#### 1) 주소록 프로젝트 생성

- 주소록 프로젝트 생성과 설정 순서
  1. 프로젝트 생성
  2. 기본 생성 파일 삭제
  3. 프로젝트 기본 폴더 생성
- addressBook 프로젝트 생성
  1. Projects 폴더로 이동 ($ cd ~/Projects)
  2. addressBook 프로젝트 생성 ($ meteor create addressBook)
  3. 디렉토리 이동 ($ cd addressBook)
  4. lib 폴더 생성 ($ mkdir lib)
  5. 이제 코드를 작성할 준비가 되었다.

> 프로젝트 생성 및 파일 저장 시 주의할 점
>
> 1. 프로젝트 경로 및 프로젝트 이름을 한글로 사용하지 않을 것
> 2. *.js, *.html 파일은 UTF-8로 편집 및 저장할 것

<br>

> 클라이언트에서 사용하는 HTML, JavaScript, 스타일 시트 파일은 client 폴더,
>
> 서버에서 실행할 JavaScript 파일은 server 폴더,
>
> 클라이언트와 서버가 공통으로 사용하는 코드는 lib 폴더에 작성한다.

<br>

#### 2) 미티어 컬렉션 생성

> 미티어 컬렉션은 미티어에서 기본으로 제공하는 오브젝트를 말한다. 미티어에서 몽고DB의 데이터를 다루는 가장 기본적인 메소드들을 가지고 있다. 미티어 컬렉션은 몽고DB 컬렉션과 1:1로 매핑된다. 몽고DB 컬렉션에 JSON document가 저장되므로 몽고DB를 document 데이터베이스라고 부른다. 따라서 미티어 컬렉션이 다루는 대상도 결국 몽고DB에 있는 JSON document이다.

- 몽고DB는 미티어의 내장 데이터베이스이며, 이를 다루기 위한 필수 오브젝트가 미티어 컬렉션이다.
- 우리가 만들 프로젝트에서 대부분의 코드가 이 컬렉션을 주로 사용한다고 해도 과언이 아니다.


<br>

1. 디렉토리 이동 ($ cd lib)
2. collection.js 파일 생성
3. 생성한 파일을 에디터로 열어서 컬렉션 선언 (AddressBook = new Mongo.Collection("addressBook");\\)

- Mongo.Collection 메소드는 new 키워드와 함께 사용하며, 몽고DB의 실제 컬렉션명(addressBook)을 입력받아 해당 컬렉션을 제어할 수 있는 미티어 컬렉션(AddressBook)을 반환한다.

> **컬렉션명 대소문자의 관례**
>
> 몽고DB 컬렉션명은 소문자로 쓰고 미티어 컬렉션명의 시작은 대문자로 한다.
>
> 둘 이상의 단어로 구성된 컬렉션은 두 번째 단어부터 각 단어의 첫 글자를 대문자로 작성하기로 한다.

<br>

#### 3) 주소록 초기 데이터 생성

- 주소록 초기 데이터 삽입을 위한 순서
  1. 컬렉션 선언 - collection.js
  2. 초기 데이터 작성 - fixture.js
  3. 미티어 최초 구동 시 insert - fixture.js

<br>

1. 파일 생성 (~Projects/addressBook/server/fixture.js)
2. AddressBook 컬렉션에 등록될 주소록을 fixtures 오브젝트 배열 변수로 선언 (github 예제 파일 사용)
3. 몽고 셸 열기 (~/Projects/addressBook$ meteor mongo)
4. 데이터 확인 (meteor:PRIMARY> db.addressBook.find())

- fixtures 배열의 객체 하나하나를 몽고DB에 입력하려면 fixture.js에서 AddressBook(미티어 컬렉션 오브젝트)의 insert 메소드를 사용해야 한다.


- Meteor.startup 메소드는 실행될 구문을 함수 형태(콜백 함수)로 전달받아 미티어를 처음 실행할 때 1번만 실행된다. 따라서 데이터가 없으면(AddressBook.find().count()의 반환값이 0이면) AddressBook.insert 메소드를 사용해 fixtures 배열의 오브젝트를 하나씩 생성했다.
- 몽고 셸은 미티어 프로젝트 폴더에서 meteor mongo 명령으로 띄울 수 있다. 단, 미티어가 실행 중이어야 한다. meteor run으로 미티어를 실행 중인 상태는 유지하고, 콘솔을 하나 더 열어서 프로젝트 폴더에서 meteor mongo를 입력하면 몽고DB 프롬프트가 표시된다. 이 프롬프트는 몽고DB 자체에서 제공하는 몽고셸이다. 
- 몽고DB는 JSON 기반이다.

> **db.addressBook.find()**
>
> 몽고DB 콘솔은 자바스크립트 콘솔이다. 우리가 데이터를 저장하는 컬렉션은 db 오브젝트의 하위 오브젝트다. 따라서 db.addressBook 형태로 접근할 수 있다. 모든 컬렉션 오브젝트는 데이터를 조회할 수 있는 find 메소드를 가지고 있다. 따라서 몽고DB 콘솔에서 db.컬렉션이름.find() 형태로 실행하면 데이터를 조회할 수 있다.

<br>

> **몽고DB의 데이터를 삭제하거나 초기화하는 방법**
>
> 몽고 셸에서 삭제 명령을 하면 몽고DB에 입력된 데이터를 모두 삭제할 수 있다.
>
> <br>
>
> meteor:PRIMARY> db.addressBook.remove({});
>
> WriteResult({ "nRemoved" : 10})
>
> <br>
>
> 미티어 실행을 중지하고 미티어 초기화 명령을 사용하면 데이터를 초기화할 수 있다.
>
> ~/Projects/addressBook $ meteor reset
>
> 단, 초기화는 모든 컬렉션의 테스트 데이터를 초기화하므로 개발 환경에서만 사용해야 한다.

<br>

### 4. 주소록 목록 구현하기

- 주소록 목록의 구현 순서
  1. 파일 생성
  2. 뷰 메인 작성 (main.html)
  3. 뷰 작성하기 (addressList.html)
  4. 이름으로 정렬하기 (addressList.js)
  5. 부트스트랩 적용
  6. 헬퍼 구현 (addressList.js)

<br>

- 우선 HTML에 미티어 템플릿을 사용해 뷰를 작성하고, 이어서 해당 뷰에 데이터를 제공하는 템플릿 헬퍼(Template.helper)를 작성할 것이다.
  1. ~/Projects/addressBook/client에 addressList.html, addressList.js 생성

<br>

#### 1) 주소록 목록 뷰 작성하기

- main.html은 우리가 사용하는 애플리케이션의 메인 화면이다.
- \<html> 태그도 없는 불완전한 HTML 문서지만 신경 쓰지 않아도 된다.
- 미티어는 빌드할 때 HTML에 필요한 나머지 부분을 알아서 채운 후 클라이언트가 접속할 때 전송해준다.
- 따라서, 우리는 \<head>와 \<body> 안에만 코드를 작성하면 된다.
- 자동 생성된 main.html, main.js 파일의 내용은 모두 삭제하고 다음과 같이 작성한다.

```html
~/Project/addressBook/client/main.html

<head>
  <title>Address Book</title>
</head>

<body>
  {{> addressList}}
</body>
```

- main.html의 {{> addressList}} 태그는 addressList 템플릿이 들어갈 자리라는 표현이다. 이것은 스페이스바라는 미티어 템플릿 언어의 문법 중 삽입(inclusion) 선언이다.

> 미티어는 HTML 템플릿 문법으로 스페이스바를 사용하여 뷰를 작성한다. 모든 뷰는 \<template> 태그 아래에 작성되며, 작성된 HTML을 DOM에 렌더링하는 부분은 블레이즈(Blaze) 템플릿 엔진을 사용한다. 블레이즈 엔진은 스페이스바에서 사용할 데이터를 제공한다. 또한, DOM에서 발생한 이벤트도 관리한다.
























